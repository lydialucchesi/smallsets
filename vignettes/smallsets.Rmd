---
title: "smallsets User Guide"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 4
vignette: >
  %\VignetteIndexEntry{smallsets User Guide}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Smallset Timelines

In this vignette, we explain how to use smallsets to build Smallset Timelines. A Smallset Timeline (or Timeline) is a simple visualisation of data preprocessing decisions. More information on Timelines can be found in the Smallset Timeline paper and on YouTube.

* [ACM FAccT paper about Smallset Timelines](https://dl.acm.org/doi/abs/10.1145/3531146.3533175)
* [3-minute YouTube video](https://www.youtube.com/watch?v=_fpn02h3IUo)
* [15-minute YouTube video](https://www.youtube.com/watch?v=I_ksOv6rj1Y)

## Example dataset{#example}

In this vignette, we use the synthetic dataset s_data, which is included in smallsets. It contains 100 observations and 8 variables (C1-C8). See `?s_data` for more information.

```{r}
library(smallsets)

head(s_data)
```

## Quick start example

Run this block of code to build a Smallset Timeline. In RStudio, the figure will appear in the plots pane.

```{r timeline1, fig.width=7, fig.height=3, fig.retina=2, fig.align="center"}
library(smallsets)

set.seed(145)

Smallset_Timeline(data = s_data, 
                  code = system.file("s_data_preprocess.R", package = "smallsets"))
```

**Normally, you pass a character string to `code` (e.g., "my_code.R" or "/.../.../my_code.R").** However, the script s_data_preprocess.R is included in smallsets as an example and needs to be called with `system.file`.

## The basics

Each Smallset Timeline is constructed from your dataset and R/R Markdown/Python data preprocessing script. Scripts must contain a series of [smallsets comments](#comments) with snapshot instructions. Your unprocessed dataset (`data`) and commented preprocessing script (`code`) are the only required inputs to `Smallset_Timeline`. 

If s_data_preprocess.R was located in your working directory, the code would look like this.

```{r, eval=FALSE}
Smallset_Timeline(data = s_data, code = "s_data_preprocess.R")
```

## Supported workflows

The smallsets package currently supports data preprocessing workflows fitting the following description.

1. Your **dataset is tabular** and of class data.frame, data.table, or tibble. Objects of class data.table and tibble are immediately converted to a data.frame by smallsets.
2. All preprocessing code is contained in **one R, R Markdown, or Python file**. Jupyter notebooks (i.e., files with extension .ipynb) are not currently supported.
3. The **preprocessing code does not change the row names** of the original data object as smallsets tracks rows by their names. Merges, joins, collapses, aggregations, and switches between the wide/long format generally involve writing over existing row names and are therefore generally not currently supported by smallsets. Renaming a column results in a column deletion then addition in the Timeline.
4. All preprocessing **package dependencies are loaded** in the current R session. Information on installing Python packages with `reticulate` can be found [here](https://rstudio.github.io/reticulate/articles/python_packages.html).

## Structured comments{#comments}

To make a Smallset Timeline with smallsets, add structured comments with snapshot instructions to your preprocessing script. All smallsets comments follow the same formula.

<font size="4"> 
**<span style="color: red;">#</span> + <span style="color: red;">smallsets</span> + <span style="color: red;">*instruction*</span> + <span style="color: red;">*place*</span> + <span style="color: red;">*name of data object*</span> + <span style="color: red;">caption[...]caption</span>**
</font>

**Example:** ```# smallsets snap +4 mydata caption[I removed rows because they contained implausible values.]caption```

#### <span style="color: red;">instruction</span>
There are four instructions available.

1. start
3. end
3. snap
4. resume

In your script, *start* and *end* instructions must be provided. The *snap* instruction is for taking intermediate snapshots. The *resume* instruction is discussed in the section on [resume markers](#resume).

#### <span style="color: red;">place</span>

There are three options for this argument.

1. Specify the line of code that you would like the snapshot to be taken after, e.g., 17 means take the snapshot after the 17th line of code.
2. Use a plus sign and a number to specify how many lines of code later to take the snapshot, e.g., +2 means take the snapshot two lines of code later.
3. Don't specify anything, and a snapshot will be taken after the subsequent line of code.

#### <span style="color: red;">name of data object</span>
The name of the data object can change throughout the script. The snapshot is taken of the object specified in the comment.

## Example R script
**s_data_preprocess.R** (Don't run this code block. It's an example preprocessing script.)
```{r, code = readLines(system.file("s_data_preprocess.R", package = "smallsets")), eval=FALSE}
```

## R Markdown example
Smallset Timelines can be built for preprocessing code in R Markdown files. If you choose to include the Smallset Timeline as a figure within the R Markdown report itself, it works best to build the Smallset Timeline before the preprocessing code is executed, so that you don't have to reload your (un-preprocessed) data later to build the Smallset Timeline. You assign the Smallset Timeline figure to an object, hiding that code with `echo=FALSE`. You can then plot it anywhere in the report. See the example below.

**s_data_preprocess.Rmd** (Don't run this code block. It's an example script.)
```{R, code = readLines(system.file("s_data_preprocess.Rmd", package = "smallsets")), eval=FALSE}
```

To see the compiled report, run the following code. It will write a PDF titled s_data_preprocess.pdf to your working directory.
```{R, eval=FALSE}
rmarkdown::render(system.file("s_data_preprocess.Rmd", package = "smallsets"),
                  output_dir = getwd())
```

## Python example
Python scripts can be passed to the R command `Smallset_Timeline`.
```{r, eval=FALSE}
Smallset_Timeline(data = s_data, 
                  code = system.file("s_data_preprocess.py", package = "smallsets"))
```

Below is the script s_data_preprocess.py, which does the same thing as s_data_preprocess.R. The smallsets commenting system is the same in Python.

**s_data_preprocess.py** (Don't run this code block. It's an example preprocessing script.)
```{python, code = readLines(system.file("s_data_preprocess.py", package = "smallsets")), eval=FALSE}
```

## Isolate a data deletion

If you'd like to isolate a data deletion in an intermediate snapshot, leave a blank line between the structured comment and the data deletion code. For example, if we want to split the middle Timeline snapshot into two snapshots, we can add another structured comment, and blank line, before the data deletion code.

**s_data_preprocess_4.R** (Don't run this code block. It's an example preprocessing script.)
```{R, code = readLines(system.file("s_data_preprocess_4.R", package = "smallsets")), eval=FALSE}
```

```{r timeline2, fig.width=7, fig.height=3, fig.retina=2, fig.align="center"}
set.seed(145)

Smallset_Timeline(data = s_data, 
                  code = system.file("s_data_preprocess_4.R", package = "smallsets"))
```


## Smallset selection{#selection}

There are two Smallset decisions to make: how many rows (`rowCount`) and how to select them (`rowSelect`).

If `rowSelect = NULL` (the default setting), rows are selected through a simple random sample. The following code would randomly sample seven rows for the Smallset.

```{r, fig.keep="none"}
Smallset_Timeline(data = s_data, 
                  code = system.file("s_data_preprocess.R", package = "smallsets"), 
                  rowCount = 7, rowSelect = NULL)
```

To use the other two selection methods, which are optimisation problems proposed [here](https://dl.acm.org/doi/epdf/10.1145/3531146.3533175#section.5), you will need a [Gurobi license](https://www.gurobi.com/solutions/licensing/) as they rely on the [Gurobi solver](https://www.gurobi.com/solutions/gurobi-optimizer/) v9.1.2 (free academic licenses are available). Richard Schuster's ["Gurobi installation guide"](https://prioritizr.net/articles/gurobi_installation_guide.html) in the `prioritizr` package provides step-by-step instructions on installing Gurobi in R.

If `rowSelect = 1`, the *coverage* problem is used to select rows. For each snapshot, it finds at least one example of a data change, if there is one. You can return the solution to the console with `rowReturn = TRUE`.

```{r, eval=FALSE, fig.keep="none"}
Smallset_Timeline(data = s_data, 
                  code = system.file("s_data_preprocess.R", package = "smallsets"), 
                  rowCount = 5, rowSelect = 1, rowReturn = TRUE)
```

```{r, echo=FALSE, fig.keep="none"}
Smallset_Timeline(data = s_data, 
                  code = system.file("s_data_preprocess.R", package = "smallsets"),
                  rowNums = c(27, 42, 95, 96, 99),
                  rowReturn = T)
```

After the optimisation problem is solved once, the solution can be passed to `rowNums` to avoid having to re-solve it with each run of `Smallset_Timeline`.

```{r timeline3, fig.width = 7, fig.height = 3, fig.align='center'}
Smallset_Timeline(data = s_data, 
                  code = system.file("s_data_preprocess.R", package = "smallsets"), 
                  rowCount = 5, rowNums = c(27, 42, 95, 96, 99))
```

Here, the *coverage* solution misses a data edit example in the second snapshot, motivating use of the other selection method (`rowSelect = 2`): the *coverage + variety* optimisation problem, which looks for rows affected by the preprocessing steps differently. **The drawback of `rowSelect = 2` is runtime for large datasets.** One potential workaround to a long runtime is building a Timeline from a sample of the dataset. However, this should be done with caution.

```{r, eval=FALSE}
Smallset_Timeline(data = s_data, 
                  code = system.file("s_data_preprocess.R", package = "smallsets"), 
                  rowSelect = 2, rowReturn = T)
```

```{r timeline4, echo=FALSE, fig.width = 7, fig.height = 3, fig.align='center'}
Smallset_Timeline(data = s_data,
                  code = system.file("s_data_preprocess.R", package = "smallsets"),
                  rowNums = c(3, 32, 80, 97, 99),
                  rowReturn = T)
```

## Timeline customisation{#customisation}

There are built-in options to customise a Timeline. The examples in this section highlight some of them. See `?Smallset_Timeline` for a full list of options.

**Example 1**

Some differences: custom colour palette, data in the snapshots, highlighting missing data, a different font, and no ghost data.
```{r timeline5, fig.width = 7, fig.height = 4, fig.align='center'}
set.seed(145)

Smallset_Timeline(
  data = s_data,
  code = system.file("s_data_preprocess.R", package = "smallsets"),
  colours = list(
    same = "#E6E3DF",
    edit = "#FFC500",
    add = "#5BA2A6",
    delete = "#DDC492"
  ),
  printedData = TRUE,
  truncateData = 4,
  missingDataTints = TRUE,
  ghostData = FALSE,
  font = "Palatino",
  sizing = sets_sizing(data = 1.5),
  labelling = sets_labelling(labelCol = "darker", labelColDif = 1)
)
```

**Example 2**

Some differences: use of a built-in colour palette, split into two rows, and rotated column names.
```{r timeline6, fig.width = 5, fig.height = 6, fig.align='center'}
set.seed(145)

Smallset_Timeline(
  data = s_data,
  code = system.file("s_data_preprocess.R", package = "smallsets"),
  colours = 3,
  ghostData = TRUE,
  missingDataTints = TRUE,
  font = "Arial Rounded MT Bold",
  spacing = sets_spacing(
    captions = 2,
    rows = 2,
    degree = 45,
    header = 1
  ),
  sizing = sets_sizing(
    legend = 7
    )
)
```

## Alt text{#alttext}

You can retrieve alternative text (alt text) for your Smallset Timeline. When `altText = TRUE`, a draft of alt text is printed to the console. It can be copied from the console, revised for readability, and included with the figure.

```{r, fig.keep="none", comment=''}
set.seed(145)

Smallset_Timeline(data = s_data, 
                  code = system.file("s_data_preprocess.R", package = "smallsets"), 
                  altText = TRUE)
```

## Resume markers{#resume}

A resume marker is a vertical line between snapshots signalling that preprocessing stopped to run an analysis and then resumed to facilitate a new/revised analysis. It is added to a Timeline with a *resume* instruction in a structured comment.

In this example, we resume data preprocessing to transform C9 into a categorical variable.

**s_data_preprocess_resume.R** (Don't run this code block. It's an example preprocessing script.)
```{r, code = readLines(system.file("s_data_preprocess_resume.R", package = "smallsets")), eval=FALSE}
```


```{r timeline7, fig.width = 7, fig.height = 2, fig.align='center', fig.retina = 2}
set.seed(145)

Smallset_Timeline(data = s_data, 
                  code = system.file("s_data_preprocess_resume.R", package = "smallsets"), 
                  sizing = sets_sizing(
                    columns = 1.8,
                    captions = 1.8,
                    legend = 7,
                    icons = .8
                    ),
                  spacing = sets_spacing(
                    captions = 3,
                    degree = 60,
                    header = 3.5,
                    right = 2
                    )
                  )
```
